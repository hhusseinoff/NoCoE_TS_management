# NoCoE_TS_management
Series of powershell scripts for automating SCCM OSD deployments

I. Overview
===========

The No-Continue-On-Error initiative, or NoCoE abbreviated aims to remove the use of the Continue-On-Error Flag currently in use in BFS Task sequences for Dedicated Clients. The need to do so comes from that fact that there is currently poor consistency in the quality of newly build Dedicated clients -- some may lack apps, settings or features. Also, no convenient, fast-acting and close to real-time process to give insight as to what exactly happens during the execution of BFS-s (or any other DedC Task sequences) currently exists.

1.Main components and workflow
------------------------------

The NoCoE implementation requires a high degree of automation to service machines that fail on some of the steps in them. This is primarily the result of the exceptionally poor application quality of most Core applications in use within the Environment -- e.g., during the execution of a NoCoE BFS, a step to install the FSLogix application for example, might randomly fail but then install correctly and not cause issues if a second execution of the BFS is triggered following the first.

To that end, there are 3 main components that work in unison to ensure all devices, being imaged using a NoCoE BFS, come out properly built:

**The Client-side Script**  -- It's found in the TS itself and Its function is to collect relevant data after a terminal event is reached during the execution of the sequence (either success or failure) and record that data to a Dashboard.txt file at the Script share, while also differentiating between 4 different Sequence types, 2 Device Environment types and the Release Version of the TS.

**The Script share & Dashboard**  -- Serves as a central hub to host the collected data from the client-side script and a singular place from which troubleshooting, reporting and historical data gathering can be performed on all machines that were imaged using a NoCoE BFS / NoCoE Upgrade TS, without needing to actually log on to the machines themselves.

**The Server-side scripts**  -- A series of scripts working in tandem to read the Dashboard file every 30 minutes and perform appropriate post operations on all machines, for which an entry in the Dashboard exists. The appropriate post operations vary depending on the execution result of the BFS / Upgrade TS for each individual machine

2.The Client-side Script
------------------------

It's the same for all 3 Regions and exists as an SCCM Package with no set Program. This is because it's intended to be run as a "Run Command Line" TS step, and for that no Program is needed to be specified.

### a)Input Data Collection

The Client-side script collects real-time execution data by using Task Sequence Variables. In terms of how they receive their value, they can be:

|  |
|  | ![Текстово поле: Important! There are two types of TS Variables:

Automatic -- Generated by default when a TS starts executing, recognizable by having "_" as the first character of the variable name or "OSD" as the first three of the variable name:
Custom -- Created explicitly under a Set Task Sequence Variable, Set Dynamic Variables step types or created explicitly when the output of a Run Powershell Script or Run Command Line step is fed to a variable:

](file:///C:/Users/mr_cr/AppData/Local/Temp/msohtmlclip1/01/clip_image009.png) |

####  i. Explicit

An engineer must manually set their value when creating the sequence.

##### 1) Set Release Version

Defines the name of the Release. Basically, having a set number of applications with specific versions placed under the umbrella of a single Release Version string (also commonly referred to as Image Version) enables you to quickly identify that a machine running on PR002 for example will have apps x, y, z installed and setting o, p q set.

It's essentially a way of branding a machine. And it's quite important in many regards besides the above -- Many reports use the Release Version as an identifier of compliance.

##### 2) IsBFS Modifier

**Must be a string of either "Yes" or "No".**

Determines whether the sequence is intended to be used for BFS (new devices) or Upgrade (bi-monthly releaes) and what the folder in which the Dashboard is housed will be called.

##### 3) IsSAC Modifier

**Must be a string of either "Yes" or "No".**

Determines whether the sequence is intended to be used for SAC Devices (carrying a Windows Version greater than what's currently out there, e.g. 22H2) or not and what the folder in which the Dashboard is housed will be called.

##### 4) FailedStepName (Only if the execution was successful)


**Must always be a string of "NoStepsFailed".**  Acts as a keyword. If it's set to something else, the Client-side script will wrongly assume that the execution was a failure.

##### 5) FailedStepReturnCode (only if the execution was successful)

**Can be any string. **Has no impact if the execution was successful.**

**

####  ii. Dynamic

An engineer sets template values, **but the variables themselves only get assigned 1 of the possible template values, depending on a criterion (if clause).** This is accomplished using Set Dynamic Variables TS step

##### 1)   

"Gather Machine Specific Variables"\
The following NoCoE-related variables are set here

**DeviceEnvironment**: Can be either INT or PROD

**TSLogShare**: This is the script share, different for each data center:

**CONFIDENTIAL**

##### 2) "Gather Data about the failed step" -- Only in case of Failure

***Assigns the values of the relevant automatic TS variables to Custom variables***:

***Also sets the overall TS execution result marker*** variable called **MainBodySuccess**  to **False**

***Also sets the default dialog timeout to 24 hrs*** -- this has the effect that it prevents a machine that has failed a step from being accessible to end users and engineers until the Server-side scripts take care of the machine

Side effect here is also that via the VMWare console, ***you can visually determine which step has failed, by moving the dialog window. Useful for manual troubleshooting***.

####  iii. Automatic

***Generated by default by the TS manager, with most of them, their values explicitly passed to custom variables:


**_SMSTSMachineName**
**_SMSTSLastActionName**
**_SMSTSLastActionRetCode**
**_SMSTSLogPath** - Gets the location where the SMSTS log is hosted at during the TS Exection. It is hosted at various different directories during the various stages of the execution, e.g. Before and OS Image is applied, at X:\Windows\CCM\Logs\SMSTaskSequence

 |

### d)Determining the Sequence Type

***The combination of the IsBFS and IsSAC modifiers create the following 4 potential Sequence types:

| IsBFS	| IsSAC	| Resulting Sequence Type |
| ------------- | ------------- | ------------- |
| No	| No	| Upgrade – for regular bi-monthly releases |
| Yes	| No	| BFS – For regular newly created machines |
| No	| Yes	| SAC_Upgrade – For upgrades targeting SAC machines (higher winver) |
| Yes	| Yes	| SAC_BFS – for newly created SAC Machines (higher winver) |

| First Header  | Second Header |
| ------------- | ------------- |
| Content Cell  | Content Cell  |
| Content Cell  | Content Cell  |

***The resulting sequence type is also resolved by the server-side scripts.***

### e)Creating Folder Structures and the Dashboard file

The sequence types in conjunction with the **ReleaseVersion**  also determine the folder structure at the script share and where the Dashboard will be located:

|

**Sequence Type**

 |

**Device Environment**

 |

**Release Version**

 |

**Example Resulting Folder Path / Dashboard Path**

 |
|

**BFS**

 |

INT

 |

PR001_23_PR023

 |

\\aalwshfrk402\Dedicated_TS_Management\BFS\INT\PR001_23_PR023\Dashboard.txt

 |
|

**SAC_BFS**

 |

INT

 |

PR001_23_PR023

 |

\\aalwshfrk402\Dedicated_TS_Management\SAC_BFS\INT\PR001_23_PR023\Dashboard.txt

 |
|

**Upgrade**

 |

INT

 |

PR001_23_PR023

 |

\\aalwshfrk402\Dedicated_TS_Management\Upgrade\INT\PR001_23_PR023\Dashboard.txt

 |
|

**SAC_Upgrade**

 |

INT

 |

PR001_23_PR023

 |

\\aalwshfrk402\Dedicated_TS_Management\SAC_Upgrade\INT\PR001_23_PR023\Dashboard.txt

 |
|

**BFS**

 |

PROD

 |

PR001_23_PR023

 |

\\aalwshfrk402\Dedicated_TS_Management\BFS\PROD\PR001_23_PR023\Dashboard.txt

 |
|

**SAC_BFS**

 |

PROD

 |

PR001_23_PR023

 |

\\aalwshfrk402\Dedicated_TS_Management\SAC_BFS\PROD\PR001_23_PR023\Dashboard.txt

 |
|

**Upgrade**

 |

PROD

 |

PR001_23_PR023

 |

\\aalwshfrk402\Dedicated_TS_Management\Upgrade\PROD\PR001_23_PR023\Dashboard.txt

 |
|

**SAC_Upgrade**

 |

PROD

 |

PR001_23_PR023

 |

\\aalwshfrk402\Dedicated_TS_Management\SAC_Upgrade\PROD\PR001_23_PR023\Dashboard.txt

 |

![Текстово поле: Important! There can and will obviously by separate folders for each Release Version when all other parameters are constant

](file:///C:/Users/mr_cr/AppData/Local/Temp/msohtmlclip1/01/clip_image023.png)

### f)Collecting OS Info

![](file:///C:/Users/mr_cr/AppData/Local/Temp/msohtmlclip1/01/clip_image025.jpg)\
The Client-side script also collects information about the OS Version by constructing a string from the relevant registries on the machine:

### g)Dashboard Entry Operations

![](file:///C:/Users/mr_cr/AppData/Local/Temp/msohtmlclip1/01/clip_image027.jpg)

The script appends an entry for the executing machine at the appropriate dashboard file.

|  |
|  | ![Текстово поле: Important! Historical Data can be obtained by the server-side scripts

](file:///C:/Users/mr_cr/AppData/Local/Temp/msohtmlclip1/01/clip_image028.png) |

***Historical Data is not preserved.*** There can only be 1 entry for a machine in each Dashboard file. ***This is done on purpose so that always the most recent execution result data can be copy-pasted from the Dashboard to an excel file for easy overview of how successful the release has been.***

![Текстово поле: Important! NEVER USE BRACKETS IN TS STEP NAMES! Using them prevents the Main server-side script from replacing the entry for the machine in the Dashboard file, which could result in a machine being improperly branded as a failure and stuck in a constant boot loop. Root cause of the issue is the way that the -replace Powershell operator works.

](file:///C:/Users/mr_cr/AppData/Local/Temp/msohtmlclip1/01/clip_image029.png)

### h)Log Retrieval Operations\
If the TS Execution has been a failure, the **smstslog**, containing information about everything that occurred during the execution of the TS is automatically uploaded to the script share.

![](file:///C:/Users/mr_cr/AppData/Local/Temp/msohtmlclip1/01/clip_image032.png)

This is particularly useful with BFS sequences, since if something fails during initial OSDdeployment it's very inconvenient to dig up the smstslog, due to the lag from the VMWare Console and the need to basically use the WinPE as a medium. This is because until the execution is finished and the machine is restarted, any command line tools will start from the perspective of WinPE, not being able to make use of the local HW Resources on the machine.

***Following a successful TS Execution after an initial failure, the TS logs from the failure are deleted to conserve disk space at the script share.***

### i)Local Registry branding (Not working)

![](file:///C:/Users/mr_cr/AppData/Local/Temp/msohtmlclip1/01/clip_image035.png)\
The Client-side script also attempts to create a subkey at **HKLM:\SOFTWARE\AVC** that contains some of the most relevant data about the execution result:

This is useful since, it can be imported in SCCM as a custom class, making it extremely easy to get actual real-time data about which TS Executions have been successful on a particular machine, when the server-side scripts have performed post-operations, etc.

**At the time of writing, this function is not working, because the account under which the Client-side script is run, is not a local administrator on the machine during the execution of the TS.**

![](file:///C:/Users/mr_cr/AppData/Local/Temp/msohtmlclip1/01/clip_image037.jpg)

***This can be fixed by adding the relevant account as an admin in the beginning of the TS, or moving this function to a separate step:***

### j)Local Client-side script logs

![](file:///C:/Users/mr_cr/AppData/Local/Temp/msohtmlclip1/01/clip_image038.png)\
For troubleshooting purposes, the Client-side script also created a local Verbose log on the system that details every operation made.

It can be found at:

3.The Server-side Scripts
-------------------------

### a)General organization

As of the time of writing there are 8 worker scripts, each performing a specific action for a single machine and 1 Main script that coordinates when the workers are called for each machine for which data from the Dashboard File has been retrieved.

This modular structure allows the individual workers to be easily edited without completely halting the NoCoE. Another bonus is the fact that you'd need to stare at fewer lines of code.

***In the future this also allows additional worker scripts to be created, performing additional new actions.***

![](file:///C:/Users/mr_cr/AppData/Local/Temp/msohtmlclip1/01/clip_image039.png)\
**The Main TS Manager script (and therefore by extension -- the workers as well) needs 5 input parameters to execute**:

**and is intended to run as a Scheduled task on the Script Share, periodically to perform post operations as frequently as possible on the target device types.**

### b)Scheduled Tasks

|  |
|  | ![](file:///C:/Users/mr_cr/AppData/Local/Temp/msohtmlclip1/01/clip_image040.png) |

As previously mentioned, since 5 input parameters are required, different scheduled Tasks with different parameters must coexist:

|  |
|  | ![](file:///C:/Users/mr_cr/AppData/Local/Temp/msohtmlclip1/01/clip_image042.jpg) |

***This has the benefit and flexibility of having separate scanning / post-ops frequencies for different Sequence types and devices.***

For example, since Upgrade Sequences for PROD are intended to run on weekends only and are therefore concentrated in a span of 48 hours or less, the execution frequency for that scheduled Task can be set to be every 10 minutes and only on Saturdays and Sundays, and additionally parallel instances of the Task can be enabled to combat the relative high activity spike.

By contrast since new devices are created throughout the week, the BFS PROD Task can be set to ![Текстово поле: Important As it's obvious, a Release Version Name must be supplied to the script and therefore the scheduled task. This necessitates that an engineer manually changes the string in the properties of the Task:

This is done entirely on purpose -- A recuring issue had been the fact that few people know of all DedC Processes running in the background and therefore can't answer questions, manage, or deal with situations. i.e., a human element bottleneck is created.

By making it one of the build engineer's responsibilities to change the Release Version string twice a month, familiarity is established more or less

](file:///C:/Users/mr_cr/AppData/Local/Temp/msohtmlclip1/01/clip_image044.png)\
execute every 2 hours, every day.

### c)Scenarios

|  |
|  | ![Текстово поле: Important When post operations by the server-side scripts are performed for a given machine, the PostOpsPerformed property is changed to "Yes". This ensures that post-ops will be performed only once per machine, and any potential boot loops will be avoided.

In the future, adding additional scenarios beyond Success / Failure can be implemented in the script as an additional tool to remedy commonly observed large-scale failure phenomena.
](file:///C:/Users/mr_cr/AppData/Local/Temp/msohtmlclip1/01/clip_image046.png) |\
They represent a given set of actions that need to be performed against a specific TS execution result for a given machine -- e.g. Succcess / Failure.

### d)Server-side Scripts Log types and organization

####  i. Verbose Logs

![](file:///C:/Users/mr_cr/AppData/Local/Temp/msohtmlclip1/01/clip_image048.jpg)\
Contain detailed verbose information for every action taken during every execution of the Main and Worker scripts. Can be used for troubleshooting.

![](file:///C:/Users/mr_cr/AppData/Local/Temp/msohtmlclip1/01/clip_image050.jpg)

####  ii. Short Logs

![](file:///C:/Users/mr_cr/AppData/Local/Temp/msohtmlclip1/01/clip_image053.png)\
Contain bare minimum information regarding actions taken by the Worker scripts and care formatted with tab character separators and Header lines to enable easy copy-pasting to excel sheets.

**Depending on the outcome of the operation, can be either**

**Of the _FailSkip Type** -- containing failures information.

|  |
|  | ![](file:///C:/Users/mr_cr/AppData/Local/Temp/msohtmlclip1/01/clip_image054.png) |

![](file:///C:/Users/mr_cr/AppData/Local/Temp/msohtmlclip1/01/clip_image055.png)\
**Of the _Success Type** -- containing successful executions information.

**\
**

4.Main TS Manager script

----------------------------

### a)XD Operation scripts: MM mode enable / disable

![](file:///C:/Users/mr_cr/AppData/Local/Temp/msohtmlclip1/01/clip_image056.png)

They Set MM on or off respectively for a particular machine. **Reason for them to be executed on the server-side is because, issuing commands to the XD Controllers in a state where the client is not in Full OS mode (meaning BFS executions) always results in errors.**

### b)XD Operations: Success/ Fail Tags

![](file:///C:/Users/mr_cr/AppData/Local/Temp/msohtmlclip1/01/clip_image057.png)

Tags machines with the appropriate Build / Upgrade tag. The tags are (**created as objects in advance at all DedC XD Controllers: AALXNDFRK101, AALXNDPAR005, AALXNDPAR401, AALXNDPHX001, AALXNDEDS001, AALXNDSGP201, AALXNDSYD201**):

![](file:///C:/Users/mr_cr/AppData/Local/Temp/msohtmlclip1/01/clip_image058.png)

**For BFS Executions the Build Tags are used by the Assignment Script to assign properly built machines to end users.**

### c)XD Operations: ImgVer Tags

![](file:///C:/Users/mr_cr/AppData/Local/Temp/msohtmlclip1/01/clip_image059.png)

Tag the machine with an ImgVer Tag, enabling easy filtering through the XD Consoles.

![](file:///C:/Users/mr_cr/AppData/Local/Temp/msohtmlclip1/01/clip_image061.jpg)

### d)SCCM Operations: Collection membership changes

####  i. Update Memberships:

####  ii. Remove Device from Collection:

![](file:///C:/Users/mr_cr/AppData/Local/Temp/msohtmlclip1/01/clip_image062.png)

### e)SCCM Operations: PXE Deployments clearing

Clears the required PXE Deployments for the machine.

![](file:///C:/Users/mr_cr/AppData/Local/Temp/msohtmlclip1/01/clip_image063.png)

***In the SCCM database there's data for which Required PXE Deployments have been executed on a machine. SCCM uses that data to allow / not allow a subsequent exection of the deployment.***

***By clearing that Required PXE Deployments flag for a given machines, the next time the machine is restated it will automatically pick up and start executing the deployment again -- useful for BFS Sequences.***

![Текстово поле: Important After the command to clear PXE Deployments for a given machine is issued, there's a cooldown period of about 90 seconds that must pass for the change to go into effect, hence the programmed CooldownInterval:](file:///C:/Users/mr_cr/AppData/Local/Temp/msohtmlclip1/01/clip_image064.png)

![Текстово поле: Important This setup doesn't work with UEFI Machines. This is because if a machine has been formatted as UEFI, the EFI Boot manager will be the first boot option for the VM no matter what, therefore even if you clear the Required PXE Deployments, the machine still wouldn't start running the Sequence again. There doesn't seem to be a way around this, because in order to have a UEFI-enabled Windows Installation, and EFI partition must be created and that's exactly where the EFI Boot manager is located on the device drive. Additionally, there doesn't seem to be a way to modify the VM .vmdk file to expect a Boot order change on the OS-level.](file:///C:/Users/mr_cr/AppData/Local/Temp/msohtmlclip1/01/clip_image065.png)

### f)VMWare Operations: Restarting a VM

![](file:///C:/Users/mr_cr/AppData/Local/Temp/msohtmlclip1/01/clip_image066.png)

Restarts a given machine in VMWare.

**Has two restart modes**:

**Hard**  -- equivalent to pressing the restart button on a physical machine, when executed the machine is restarted immediately. If the machine has an OS, system files could be corrupted because of this. Therefore this is the preferred restart method for BFS Execution where data preservation after a failed BFS is not a concern.

**Soft**  -- equivalent to clicking Power -- Restart from the start menu. Command is issued to the Guest OS of the VM through VMWareTools. Safer option to use for Upgrade Sequences. **Note that VMWare Tools must be installed in Windows to enable this power action.**
